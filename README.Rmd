---
title: "PedsPheWAS R package"
author: "Monika Grabowska"
date: "January 30, 2024"
output: html_document
---

## Introduction

The PedsPheWAS R package is designed to perform phenome-wide association studies (PheWAS) using pediatric phecodes (Peds-Phecodes). 

This package was built based on the original PheWAS R package available at: https://github.com/PheWAS/PheWAS 
 
## Installation
To install the latest development version of the PedsPheWAS R package, use the following code:

```{r setup1, echo = TRUE, message = FALSE, warning = FALSE}
# install and load required packages 
packages <- c("devtools","vroom","tidyverse","dplyr","parallel")
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
invisible(lapply(packages, library, character.only = TRUE))
```

```{r setup2, echo = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
# install PedsPheWAS package
devtools::install_github("monikagrabowska/PedsPheWAS")
library(PedsPheWAS)
```

## Tutorial 

This tutorial demonstrates how to use the PedsPheWAS R package to perform a PheWAS analysis using simulated data. 

The current version of Peds-Phecodes supports ICD-9-CM, ICD-10-CM, and SNOMED CT codes.

### 1) Prepare and load input data

To perform a PheWAS, the user must provide three data frames: 1) a data frame containing patient diagnosis codes (ICD-9-CM, ICD-10-CM, SNOMED CT) and code counts (or code index dates), 2) a data frame with patient sex (used to determine case/control/exclude status for sex-specific phecodes), and 3) a data frame containing the patient genotypes. 

An example of each of these data frames is provided below, showing the required column formatting.  

```{r step1a}
example_data_icd <- vroom::vroom("./data/person_icd.csv",
                                 .name = janitor::make_clean_names, delim = ",",
                                 col_types = c(id = "i", vocabulary_id = "c", code = "c", count = "i"))
```

```{r step1b, echo = FALSE}
rmarkdown::paged_table(example_data_icd)
```

```{r step1c}
example_data_sex <- vroom::vroom("./data/test_sex.csv",
                                 .name = janitor::make_clean_names, delim = ",",
                                 col_types = c(id = "i", sex = "c"))
```

```{r step1d, echo = FALSE}
rmarkdown::paged_table(example_data_sex)
```

```{r step1e}
example_data_genotypes <- vroom::vroom("./data/test_genotypes.csv",
                                       .name = janitor::make_clean_names, delim = ",",
                                       col_types = c(id = "i", rs_example = "i"))
```

```{r step1f, echo = FALSE}
rmarkdown::paged_table(example_data_genotypes)
```

### 2) Mapping patient diagnosis codes to pediatric phecodes (Peds-Phecodes)

The createPedPhenotypes() function maps ICD-9-CM, ICD-10-CM, and SNOMED CT codes to Peds-Phecodes.

```{r step2a, echo = TRUE, message = FALSE}
ped_phenotypes <- createPedPhenotypes(example_data_icd, example_data_sex)
```

The function returns a data frame of boolean phenotypes, in which the first column contains patient IDs and the remaining columns indicate case/control/exclude status (i.e., TRUE/FALSE/NA) for each phecode. 

The example output is shown below: 

```{r step2b, echo = FALSE}
rmarkdown::paged_table(ped_phenotypes)
```

### 3) Preparing data for PheWAS 

Join the patient genotype data to the boolean phenotypes generated by the createPedPhenotypes() function to create the data frame needed to perform PheWAS. If planning to adjust for covariates (e.g., age, gender), these should also be joined to the data frame.   

```{r step3a}
df_full <- inner_join(example_data_genotypes, ped_phenotypes, by = "id")
```

The final data frame is shown below: 

```{r step3b, echo = FALSE}
rmarkdown::paged_table(df_full)
```

### 4) Performing PheWAS 

The phewas_ext() function performs the PheWAS using the data frame with phenotype, genotype, and any covariate data. 

```{r step4a, echo = TRUE,  message = FALSE}
results <- phewas_ext(phenotypes=names(ped_phenotypes)[-1], genotypes = colnames(example_data_genotypes)[2], df_full)
```

The example output is shown below:

```{r step4b, echo = FALSE}
rmarkdown::paged_table(results)
```

### 5) Plotting PheWAS results

The results of the PheWAS can be visualized in a Manhattan plot using the plotManhattan() function. The Manhattan plot shows the negative log p-value of the associations, with phecodes arranged on the x-axis by disease category. Annotations can be added to the plot to highlight notable associations. 


Note: To show all desired annotation labels regardless of overlap, run the following code:
```{r step5a}
options(ggrepel.max.overlaps = Inf)
```


##### 1) Manhattan plot with annotations specified using annotate.level:

```{r step5b}
test_plot1 <- plotManhattan(results, annotate.phenotype = T, annotate.level = 0.005, y.axis.interval = 1)
```



##### 2) Manhattan plot with annotations specified using annotate.list: 

```{r step5c}
test_plot2 <- plotManhattan(results, annotate.phenotype = T, annotate.list = c("622"), y.axis.interval = 1)
```



##### 3) Manhattan plot without annotations: 

```{r step5d}
test_plot3 <- plotManhattan(results, annotate.phenotype = F, y.axis.interval = 1)
```


## Citations
##### Peds-Phecodes:
Grabowska ME, Van Driest SL, Robinson JR, Patrick AE, Guardo C, Gangireddy S, Ong HH, Feng Q, Carroll R, Kannankeril PJ, Wei WQ. Developing and evaluating pediatric phecodes (Peds-Phecodes) for high-throughput phenotyping using electronic health records. J Am Med Inform Assoc. 2024 Jan 18;31(2):386-395. doi: 10.1093/jamia/ocad233. PMID: 38041473; PMCID: PMC10797257.

##### Original PheWAS R package: 
Carroll RJ, Bastarache L, Denny JC. R PheWAS: data analysis and plotting tools for phenome-wide association studies in the R environment. Bioinformatics. 2014 Aug 15;30(16):2375-6. doi: 10.1093/bioinformatics/btu197. Epub 2014 Apr 14. PMID: 24733291; PMCID: PMC4133579.
